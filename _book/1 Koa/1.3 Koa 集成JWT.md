# Koa 集成JWT

## 什么是JWT

JWT 即为JSON Web Token的简写目前最流行的跨域认证解决方案。

JWT是通过在用户经过服务器认证后，由服务器发送给客户端一串JSON字符串，而这串字符串内部存储用户的信息，以及登录过期时间等等，在用户在其后的每次请求的请求头中带上这串JWT字符，达到认证的效果。

## 格式

#### JSON 数据格式

```json
{
  "username": "zhangsan",
  "role": "user",
  "expiratAt": ""
}
```

#### 字符数据格式

```js
Header.Payload.Signature 
// 分别是三串加密字符串
```

#### 请求格式

```js
Authorization: Bearer <token> //注意中间有个空格
```

#### Header 格式

```json
{
  "alg": "HS256", // 加密方式  默认是hs256
  "typ": "JWT"   //令牌类型  
}
```

####  Payload

```js
iss (issuer)：签发人
exp (expiration time)：过期时间
sub (subject)：主题
aud (audience)：受众
nbf (Not Before)：生效时间
iat (Issued At)：签发时间
jti (JWT ID)：编号
//官方指定的 7个字段
//可以自己定义新的字段不受限制
//JWT 的payload  默认是不加密的  所以不要将敏感数据放在着
```

#### Signature

服务器对于JWT的签名，放置JWT被篡改 ，签名需要Header  和Payload  以及一个 服务器的Key  进行加密

```js
HMACSHA256(  //默认是 HMACSHA256 加密 
  base64UrlEncode(header) + "." + // 头部
  base64UrlEncode(payload),    //payload
  secret)  // 加密钥
```

## 常见的使用方式

可以存储在 

1. cookie 内部
2. 存储在localstorage 中

使用

1. cookie 发送  不能跨域
2.  随着 Header 添加字段  Authorization: Bearer <token> //注意中间有个空格
3. post  请求的时候放在post请求的数据体内
4. 因为Axios  可以设置拦截器与请求头自动 所以常放在Header 中与Axios一起使用
5. 因为JWT 的服务器控制权比较低，也就是令牌发送后服务器就不能确定这个另外的使用者是否更换了，所以过期时间一般设置较短，另外容易发生JWT 被劫持，因此必须配合HTTPS使用。
6. JWT 建议加密

## JWT黑名单

1. 客户端要求失效，可以对非正常操作过期时间直接设置为0的方式，
2. 如果token 储存在redis 中可是在redis 中设置黑名单，对于黑名单用户拒绝服务
3.  客户端可以一键设置黑名单
4.  用户重置密码 将token失效。
5. 

分成两点，客户端要求失效，服务端记录token到黑名单；用户重置密码，服务端记录uid-time键值对，在此之前的token全部失效；

